## Домашнее задание №6.

Реализовать распределенную транзакцию в микросервисной архитектуре.

Можно использовать приведенный ниже сценарий для интернет-магазина или придумать свой.
Дефолтный сценарий:
Реализовать сервисы "Платеж", "Склад", "Доставка".
Для сервиса "Заказ", в рамках метода "создание заказа" реализовать механизм распределенной транзакции (на основе Саги или двухфазного коммита).
Во время создания заказа необходимо:

- в сервисе "Платеж" убедиться, что платеж прошел.
- в сервисе "Склад" зарезервировать конкретный товар на складе.
- в сервисе "Доставка" зарезервировать курьера на конкретный слот времени.
- Если хотя бы один из пунктов не получилось сделать, необходимо откатить все остальные изменения.

На выходе должно быть:
- описание того, какой паттерн для реализации распределенной транзакции использовался
- команда установки приложения (из helm-а или из манифестов). Обязательно указать в каком namespace нужно устанавливать и команду создания namespace, если это важно для сервиса.
- тесты в postman.
В тестах обязательно использование домена arch.homework в качестве initial значения {{baseUrl}}

---
### Описание приложения:
Приложение реализует паттерн "Сага" для построения распределенной транзакции и состоит из:
- [Сервис Оркестратор]
  Система, работающая под управлением Camunda (интегрированной в SpringBoot), 
  использует BPMN-схемы с привязанными к ним Java-делегатами. Взаимодействие с другими 
  сервисами осуществляется через REST API и брокеры сообщений, а входящие запросы 
  обрабатываются по HTTP. Для отмены локальных транзакций в микросервисах применяется 
  паттерн "Сага" с компенсирующими вызовами. При возникновении ошибок в распределенных 
  транзакциях Camunda перехватывает исключения и выполняет компенсирующие действия 
  для уже выполненных шагов. Дополнительная настройка повторных попыток в Camunda 
  и использование идемпотентных API повышают надежность системы.
  
- [Сервис Заказа]
  Когда запускается процесс оформления заказа, создается заказ со статусом PENDING. 
  После успешной оплаты статус меняется на APPROVED. Если произойдет ошибка до оплаты, 
  заказ будет отменен и статус изменится на CANCELED с помощью компенсирующей транзакции. 
  Заказ создается через REST API, а статус меняется через брокер сообщений.

- [Сервис Склада]
  Сервис хранит информацию о товарах, их цене, количестве, доступности на складе.
  Также сервис хранит информацию о заказанных товарах в отдельной таблице. При резервировании товара в заказ, доступное количество уменьшается.
  При отмене заказа количество на складе пересчитывается соответствующим образом, а записи из таблицы заказанных товаров удаляются.
  Добавление нового товара, добавление товара в заказ - по REST API. Отмена заказанных товаров - через брокер сообщений.
  
- [Сервис Доставки]
  Сервис бронирования доставки. Доставка бронируется по дате и времени суток (MORNING, AFTERNOON, EVENING).
  Невозможно забронировать два заказа на одну и ту же дату с одним таймслотом.
  На один заказ может быть забронирована только одна доставка. При отмене доставки запись из БД удаляется.
  Создание доставки - по REST API. Отмена доставки - через брокер сообщений.
  
- [Сервис Биллинга]
  Сервис управления балансом счета списывает средства только при наличии достаточной суммы.

  Если средств недостаточно, сервис вызывает исключение, отменяется распределенная транзакция и выполняются компенсирующие операции:
  - отмена заказа
  - отмена доставки
  - отмена резервирования товаров
  
  Оплата является завершающей транзакцией. После ее успешного выполнения заказ подтверждается и должен быть выполнен.

  При успешной оплате статус заказа меняется на `APPROVED`.
---

### Запуск (выделяем побольше мощей):
- `minikube start --vm-driver virtualbox --no-vtx-check --memory=24Gb --cpus=4 --disk-size=50Gb`


```bash
kubectl create namespace dadaev-arch-otus &&
helm install ex06-kafka kafka/ &&
helm install ex06-redis-order redis_order/ &&  
helm install ex06-camunda-orchestrator camunda-orchestrator_deployment/ &&
helm install ex06-arch-order order_deployment/ &&
helm install ex06-arch-store store_deployment/ &&
helm install ex06-arch-delivery delivery_deployment/ &&
helm install ex06-arch-billing billing_deployment/
```

#### Посмотреть запущенные поды

```bash
kubectl get pods -n dadaev-arch-otus`
```

### Тесты:

```bash
newman run ex-06.postman_collection.json --verbose
```

#### Результаты тестов:

[Скриншоты результатов тестов](./screenshots)

---

### Проверки

- Port-forward:
  
  `kubectl get pods -n dadaev-arch-otus -o name | grep 'arch-camunda-orchestrator-deployment-' | head -n 1 | xargs -I {} kubectl port-forward -n dadaev-arch-otus {} 8000:8000`

  Админская панель Camunda будет доступна по адресу: http://localhost:8000/camunda/app/admin/default/#/
  
   
### Очистка пространства:

```bash
helm uninstall ex06-camunda-orchestrator &&
helm uninstall ex06-arch-order &&
helm uninstall ex06-arch-store &&
helm uninstall ex06-arch-billing &&
helm uninstall ex06-arch-delivery &&
helm uninstall ex06-kafka &&
helm uninstall ex06-redis-order &&
kubectl delete namespace dadaev-arch-otus
```